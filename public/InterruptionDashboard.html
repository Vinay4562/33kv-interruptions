<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33KV Interruptions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General body styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #e2e2e2, #ffffff);
        }

        /* Header styling */
        .header {
            background-color: white;
            color: red;
            text-decoration:underline 2px;
            padding: 0px 0;
            text-align: center;      
            margin-bottom: 40px; 
            background: linear-gradient(to right, #e2e2e2, #ffffff);
        }

        .header h1 {
            font-size: 35px;
        }

        .header img {
            position: absolute; /* Position the image */
            top: 15px; /* Align the image to the top */
            left: 25px; /* Align the image to the left */
            width: 120px;
            height: 100px;
        }

        /* Navigation bar styling */
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #0056b3;
            padding: 10px 0;
            margin: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .navbar a {
            color: #fff;
            text-decoration: none;
            padding: 10px 15px;
            font-size: 1.1em;
            text-align: center;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .navbar a:hover {
            background-color: #004080;
        }

        /* Container styling */
        .container {
            padding: 30px;
            max-width: 1200px;
            margin: auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Filters and search bar styling */
        .filters {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filters label {
            margin-right: 10px;
            font-weight: bold;
        }

        .filters input[type="date"], .filters button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .filters input[type="date"] {
            flex: 1;
        }

        .filters button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .filters button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 98%;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Style for rows with 'Nil' values */
        .nil-value {
            background-color: yellow;
        }

        /* Download buttons styling */
        .download-buttons {
            margin-bottom: 20px;
            margin-left: 73%;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            display: none;
        }

        .download-buttons button {
            padding: 7px 15px;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 0.8em;
            transition: opacity 0.3s, box-shadow 0.3s;
        }

        .download-buttons button i {
            margin-right: 8px;
        }

        .download-buttons button:nth-of-type(1) {
            background-color: #13882e; /* Green */
        }

        .download-buttons button:nth-of-type(2) {
            background-color: #dc3545; /* Red */
        }

        .download-buttons button:hover {
            opacity: 0.9;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table thead {
            background: linear-gradient(to right, #003d99, #004080);
            color: #fff;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: linear-gradient(to right, #004080, #003d99);
        }

        /* Loading spinner styling */
        .loading {
            display: none;
            text-align: center;
            font-size: 1.5em;
            color: #007bff;
            margin: 20px 0;
        }

        /* Style for rows with nil values */
        .nil-value {
            position: relative;
        }

        /* Tooltip container */
        .tooltip {
            display: none;
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Show the tooltip when hovering */
        .nil-value:hover .tooltip {
            display: block;
        }

        /* Mobile View Styles */
        @media (max-width: 768px) {
            /* General body styles */
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 0;
                background: linear-gradient(to right, #e2e2e2, #ffffff);
            }

            /* Header styling */
            .header {
                background-color: white;
                color: red;
                text-decoration: underline 2px;
                padding: 10px;
                text-align: center;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 28px;
            }

            .header img {
                position: relative; /* Adjust positioning for mobile */
                width: 100px;
                height: 80px;
                margin: 0 auto;
            }

            /* Navigation bar styling */
            .navbar {
                display: flex;
                flex-direction: column; /* Stack items vertically on small screens */
                align-items: center;
                background-color: #0056b3;
                padding: 10px 0;
                margin: 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: 10px;
            }

            .navbar a {
                color: #fff;
                text-decoration: none;
                padding: 10px 15px;
                font-size: 1em;
                text-align: center;
                border-radius: 5px;
                transition: background-color 0.3s;
                display: block; /* Make links block-level for better touch targets */
            }

            .navbar a:hover {
                background-color: #004080;
            }

            /* Container styling */
            .container {
                padding: 15px; /* Reduced padding for mobile */
                margin: 0 auto;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            /* Filters and search bar styling */
            .filters {
                margin-bottom: 20px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
                flex-direction: column; /* Stack filters vertically on small screens */
            }

            .filters label {
                margin-bottom: 5px;
                font-weight: bold;
            }

            .filters input[type="date"], .filters button {
                width: 100%; /* Full width for mobile */
                padding: 10px;
                border-radius: 5px;
                border: 1px solid #ddd;
            }

            .filters button {
                background-color: #007bff;
                color: #fff;
                border: none;
                cursor: pointer;
                font-size: 1em;
                transition: background-color 0.3s, box-shadow 0.3s;
            }

            .filters button:hover {
                background-color: #0056b3;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            .search-bar {
                margin-bottom: 20px;
            }

            .search-bar input {
                width: 100%; /* Full width for mobile */
                padding: 12px;
                border-radius: 5px;
                border: 1px solid #ddd;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* Style for rows with 'Nil' values */
            .nil-value {
                background-color: yellow;
            }

            /* Download buttons styling */
            .download-buttons {
                margin-bottom: 20px;
                display: flex;
                flex-direction: column; /* Stack buttons vertically on small screens */
                gap: 10px;
                align-items: center;
                display: none;
            }

            .download-buttons button {
                padding: 10px;
                border: none;
                border-radius: 5px;
                color: #fff;
                cursor: pointer;
                font-size: 0.9em;
                transition: opacity 0.3s, box-shadow 0.3s;
                width: 100%; /* Full width for mobile */
            }

            .download-buttons button i {
                margin-right: 8px;
            }

            .download-buttons button:nth-of-type(1) {
                background-color: #13882e; /* Green */
            }

            .download-buttons button:nth-of-type(2) {
                background-color: #dc3545; /* Red */
            }

            .download-buttons button:hover {
                opacity: 0.9;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            /* Table styling */
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            table thead {
                background: linear-gradient(to right, #003d99, #004080);
                color: #fff;
            }

            table th, table td {
                padding: 10px;
                text-align: left;
                border-bottom: 1px solid #ddd;
                font-size: 0.9em; /* Adjust font size for better readability */
            }

            table th {
                background: linear-gradient(to right, #004080, #003d99);
            }

            /* Loading spinner styling */
            .loading {
                display: none;
                text-align: center;
                font-size: 1.2em;
                color: #007bff;
                margin: 20px 0;
            }

            /* Tooltip container */
            .tooltip {
                display: none;
                position: absolute;
                background-color: #333;
                color: #fff;
                padding: 5px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                z-index: 10;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }

            /* Show the tooltip when hovering */
            .nil-value:hover .tooltip {
                display: block;
            }
        }

    </style>

</head>
<body>

    <div class="header">
    <img src="logo_new.png" alt="Logo" class="logo" width="130px" height="100px">
    <h1>ùêìùêëùêÄùêçùêíùêåùêàùêíùêíùêàùêéùêç ùêÇùêéùêëùêèùêéùêëùêÄùêìùêàùêéùêç ùêéùêÖ ùêìùêÑùêãùêÄùêçùêÜùêÄùêçùêÄ ùêãùêàùêåùêàùêìùêÑùêÉ</h1>
    </div>
        
    <!-- Navigation bar -->
    <div class="navbar">
        <a href='#' class="active">Home</a>
        <a href="#">LC Procedures</a>
        <a href='https://maxregister-git-main-vinay-kumars-projects-f1559f4a.vercel.app/Displaydata_original.html'>Max-Min data</a>
    </div>

    <div class="container">
        <h1>Interruptions Dashboard:</h1>
        <div class="filters">
            <label for="fromDate">From Date:</label>
            <input type="date" id="fromDate" name="fromDate">
            <label for="toDate">To Date:</label>
            <input type="date" id="toDate" name="toDate">
            <button onclick="fetchInterruptions()">Get Data</button>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search interruptions..." onkeyup="searchTable()">
        </div>

        <div class="download-buttons">
            <button onclick="downloadExcel()">
                <i class="fas fa-file-excel"></i> Download Excel
            </button>
            <button onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
        </div>

        <table id="interruptionsTable">
            <h2 style="display: none;" id="tableHeading">
                33KV Interruptions for the 400KV Shankarpally division from [Start Date] to [End Date]
            </h2>
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Substation Name</th>
                    <th>Feeder Name</th>
                    <th>Cause of Interruption</th>
                    <th>From Date & time</th>
                    <th>To Date & time</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Add a loading spinner element -->
    <div class="loading" id="loading">Loading...</div>

    <script>
        const substationFeederMap = {
            '220/132/33KV Tandur': ["33KV Basheerabad", "33KV Karankote", "33KV Tandur", "33KV Turmamidi", "33kv Yalal", "33KV Bommarspet", "33KV Peddamul", "33KV Gouthapur", "33KV Mythra Solar", "33KV Vikarabad"],
            '220KV SS Chandanavally': ["33KV WAMIL", "33KV WFL", "33KV Chandanvally IP"],
            '132/33KV Kodangal': ["33KV Dudyal", "33KV Kodangal", "33KV Peddanandigama", "33KV Hamshanpally", "33KV Kothur", "33KV Usha solar", "33KV Winsol Solar"],
            '132/33KV Kanakamamidi': ["33KV Kethireddypally", "33KV Kanakamamidi", "33KV CHANDANVELLY-2", "33KV CHANDANVELLY-1", "33KV Moinabad", "33KV Reddypally"],
            '132/33KVSS Parigi': ["33KV Rapol", "33KV Manneguda", "33KV Siddulur", "33KV Water Grid", "33KV Divya shakthy Paper Mills", "33KV Savitri-1(12-1-2010)", "33KV Pargi ( 15-10-12)", "33KV Abhiram Steel (29-10-12)", "33KV Savitri-2 (25-2-14)", "33KV Rangampally", "33 KV Poodur", "SSJ Solar Plant(1-11-2014)", "Globle Solar Plant(23-3-2016)"],
            '132/33KVSS Puttapahad': ["33KV Puttapahad", "33KV Chowdapur", "33KV Mothkur", "33KV Nancharla", "33KV DOMA", "33Kv Salkarpet"],
            '132/33KVSS SRIRANGAPUR': ["33KV Uttharas pally", "33KV kondurg", "33KV chowdari gudem", "33kv mogili gidda", "33kv antharam", "33kv amazon", "33kv vijaya neha", "33KV binju saraya"],
            '132/33KVSS Vikarabad': ["33kv siddulur", "33KV mmepl solar KOTTAGADI", "33KV mmepl solar PEERAMPALLY", "33KV MADANA PALLY", "33KV MADANA PALLY", "33 KV VIKARABAD"],
            '132/33KV Donthanpally': ["33KV IBS", "33KV GARGI STEELS", "33KV PRAGATHI", "33KV NANAKRAMGUDA", "33KV VATTINAGULAPALLY", "33KV NARSINGHI", "33KV CBIT", "33KV SHANKARPALLY", "33 KV MEDHA SERVO", "33kV SIFY"]
        };

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '***';

            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return '***';

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${day}-${month}-${year} & ${hours}:${minutes}:${seconds}hrs`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '***';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}-${month}-${year}`;
        }

        function fetchInterruptions() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (!fromDate || !toDate) {
                alert('Please provide both "From Date" and "To Date" to fetch interruptions.');
                return;
            }

            const formattedFromDate = formatDate(fromDate);
            const formattedToDate = formatDate(toDate);

            // Show loading spinner
            document.getElementById('loading').style.display = 'block';

            fetch(`/api/interruptions?fromDate=${encodeURIComponent(fromDate)}&toDate=${encodeURIComponent(toDate)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Interruptions:', data);
                    const heading = document.getElementById('tableHeading');
                    if (data.length === 0) {
                        heading.textContent = `No interruptions found for the selected date range from ${formattedFromDate} to ${formattedToDate}.`;
                        populateTable([]);
                    } else {
                        heading.textContent = `33KV Interruptions for the 400KV Shankarpally division from ${formattedFromDate} to ${formattedToDate}`;
                        heading.style.display = 'block'; // Make the heading visible
                        data.sort((a, b) => a.substationName.localeCompare(b.substationName));
                        interruptionsMap = createInterruptionsMap(data);
                        populateTable(interruptionsMap);
                    }
                })
                .catch(error => {
                    console.error('Fetch Interruptions error:', error);
                })
                .finally(() => {
                    // Hide loading spinner
                    document.getElementById('loading').style.display = 'none';

                    // Display the download buttons
                    document.querySelector('.download-buttons').style.display = 'block';
                });
        }

        function createInterruptionsMap(interruptions) {
            const map = {};

            // Initialize map with all substations and feeders
            for (const [substation, feeders] of Object.entries(substationFeederMap)) {
                feeders.forEach(feeder => {
                    map[`${substation}_${feeder}`] = null; // Mark as null initially
                });
            }

            // Populate map with fetched interruptions
            interruptions.forEach(interruption => {
                const key = `${interruption.substationName}_${interruption.feederName}`;
                map[key] = interruption;
            });

            // Ensure every substation and feeder combination has a value (empty or with data)
            for (const key in map) {
                if (map[key] === null) {
                    map[key] = {
                        cause: '***',
                        fromDatetime: '',
                        toDatetime: '',
                        duration: ''
                    };
                }
            }

            return map;
        }

        function populateTable(interruptionsMap) {
            const tableBody = document.getElementById('interruptionsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            let serialNumber = 1;

            for (const [key, interruption] of Object.entries(interruptionsMap)) {
                const [substation, feeder] = key.split('_');
                const row = document.createElement('tr');
                
                // Check for "Nil" values and apply a class if found
                const hasNil = Object.values(interruption).includes('***');
                const rowClass = hasNil ? 'nil-value' : '';

                row.className = rowClass;

                // Create a tooltip if the row has "Nil" values
                const tooltip = hasNil ? '<div class="tooltip">No data entered</div>' : '';

                row.innerHTML = `
                    <td>${serialNumber++}</td>
                    <td>${substation}</td>
                    <td>${feeder}</td>
                    <td>${interruption.cause}</td>
                    <td>${formatDateTime(interruption.fromDatetime)}</td>
                    <td>${formatDateTime(interruption.toDatetime)}</td>
                    <td>${interruption.duration}</td>
                    ${tooltip}
                `;
                tableBody.appendChild(row);
            }
        }

        function searchTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const table = document.getElementById('interruptionsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let rowText = '';
                for (let j = 0; j < cells.length; j++) {
                    rowText += cells[j].textContent.toLowerCase() + ' ';
                }
                if (rowText.indexOf(input) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        function downloadExcel() {
            const { XLSX } = window;

            // Get the selected dates
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            // Format the dates for the heading
            const formattedFromDate = formatDate(fromDate);
            const formattedToDate = formatDate(toDate);

            // Create a heading for the Excel file
            const heading = `33KV Interruptions from ${formattedFromDate} to ${formattedToDate}`;

            // Prepare the data including the heading
            const data = Object.entries(interruptionsMap).map(([key, interruption], index) => {
                const [substation, feeder] = key.split('_');
                return {
                    "S.No": index + 1,
                    "Substation Name": substation,
                    "Feeder Name": feeder,
                    "Cause of Interruption": interruption.cause,
                    "From Date & time": formatDateTime(interruption.fromDatetime),
                    "To Date & time": formatDateTime(interruption.toDatetime),
                    "Duration": interruption.duration
                };
            });

            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Create a worksheet with the data
            const ws = XLSX.utils.json_to_sheet(data, { header: ["S.No", "Substation Name", "Feeder Name", "Cause of Interruption", "From Date & time", "To Date & time", "Duration"] });
            
            // Insert the heading as the first row in the worksheet
            const wsWithHeading = XLSX.utils.book_new();
            XLSX.utils.sheet_add_aoa(wsWithHeading, [[heading]], { origin: "A1" });

            // Append data below the heading
            const dataRange = XLSX.utils.sheet_to_json(ws, { header: 1 });
            XLSX.utils.sheet_add_aoa(wsWithHeading, dataRange, { origin: "A3" });

            // Adjust column widths (optional)
            wsWithHeading['!cols'] = [
                { width: 10 },
                { width: 25 },
                { width: 25 },
                { width: 20 },
                { width: 25 },
                { width: 25 },
                { width: 15 }
            ];

            // Append the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, wsWithHeading, "Interruptions");

            // Save the workbook
            XLSX.writeFile(wb, "Interruptions.xlsx");
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Define title and logo
            const title = 'TRANSMISSION CORPORATION OF TELANGANA LIMITED';
            const logoUrl = 'logo_new.png'; // Path to your logo image

            // Get the selected dates
            const fromDateInput = document.getElementById('fromDate').value;
            const toDateInput = document.getElementById('toDate').value;

            // Format dates from YYYY-MM-DD to DD-MM-YYYY
            const fromDate = formatDate(fromDateInput);
            const toDate = formatDate(toDateInput);

            // Add logo to the PDF
            const logoWidth = 30; // Width of the logo
            const logoHeight = 20; // Height of the logo
            doc.addImage(logoUrl, 'PNG', 20, 20, logoWidth, logoHeight);

            // Add title beside the logo
            doc.setFontSize(15);
            doc.setFont('Lora', 'bold'); // Ensure the font is available or use a default one
            doc.text(title, 10 + logoWidth + 10, 30); // Positioned beside the logo with some padding

            // Add some space before the date range title
            doc.setFontSize(13);
            const headingText = `33KV Interruption Report from ${fromDate} to ${toDate}`;
            const headingX = 20;
            const headingY = 50; // Adjusted heading Y position to reduce space

            // Add the heading text
            doc.text(headingText, headingX, headingY);

            // Draw underline for the heading
            const textWidth = doc.getTextWidth(headingText);
            doc.line(headingX, headingY + 2, headingX + textWidth, headingY + 2); // Draw line just below the text

            // Define table columns and rows
            const tableColumn = ["S.No", "Substation Name", "Feeder Name", "Cause of Interruption", "From Date & time", "To Date & time", "Duration"];
            const tableRows = Object.entries(interruptionsMap).map(([key, interruption], index) => {
                const [substation, feeder] = key.split('_');
                return [
                    index + 1,
                    substation,
                    feeder,
                    interruption.cause,
                    formatDateTime(interruption.fromDatetime),
                    formatDateTime(interruption.toDatetime),
                    interruption.duration
                ];
            });

            // Add table to PDF
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: headingY + 5, // Start the table 5 units below the heading
                theme: 'striped'
            });

            // Save the PDF
            doc.save('Interruptions.pdf');
        }
    </script>
</body>
</html>